---
name: _test
description: Test trigger workflow

on:
  workflow_call:
    inputs:
      build_matrix:
        required: true
        type: string
        description: Build matrix for the test job

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        build_matrix: ${{ fromJson(inputs.build_matrix) }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Process URLs
        id: process_urls
        uses: ./.github/actions/process_urls
        env:
          MACHINE: ${{ matrix.build_matrix.machine }}

      - name: Clone meta-ar-test repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: Audioreach/meta-ar-test
          
      - name: Print trigger
        run: |
          echo "Triggered by ${{ github.event_name }}"
          echo "Build URL: ${{ steps.process_urls.outputs.flat_build_url }}"
          echo "Build file name: ${{ steps.process_urls.outputs.filename }}"

      - name: Modify test configurations
        id: listjobs
        run: |
          kas_file="${{ matrix.build_matrix.kas_file }}"
          DIR_NAME="${kas_file%.yml}"
          target_file="ci/lava/${DIR_NAME}/boot.yaml"
          if [ ! -f "$target_file" ]; then
            echo "Target file $target_file does not exist."
            echo "target_file=" >> $GITHUB_OUTPUT
            exit 0
          fi

          TARGET=${target_file}
          FIND_PATH="${TARGET#*/}"
          DEVICE_TYPE_PATH="${FIND_PATH%/*}"
          DEVICE_TYPE="${DEVICE_TYPE_PATH#*/}"
          GITHUB_SHA="${{ github.sha }}"
          GITHUB_RUN_ID="${{ github.run_id }}"
          BUILD_FILE_NAME="${{ steps.process_urls.outputs.filename }}"
          BUILD_DOWNLOAD_URL="${{ steps.process_urls.outputs.flat_build_url }}"
          sed -i "s|{{DEVICE_TYPE}}|${DEVICE_TYPE}|g" "${target_file}"
          sed -i "s|{{GITHUB_SHA}}|${GITHUB_SHA}|g" "${target_file}"
          ESCAPED_URL=$(echo "$BUILD_DOWNLOAD_URL" | sed 's/[&/?=]/\\&/g')
          sed -i "s|{{BUILD_DOWNLOAD_URL}}|$ESCAPED_URL|g" "${target_file}"
          sed -i "s|{{BUILD_FILE_NAME}}|${BUILD_FILE_NAME}|g" "${target_file}"
          sed -i "s|{{GITHUB_RUN_ID}}|${GITHUB_RUN_ID}|g" "${target_file}"
          cat "${target_file}"

          echo "target_file=${target_file}" >> $GITHUB_OUTPUT

      - name: Test ${{ matrix.build_matrix.machine }}
        if: ${{ steps.listjobs.outputs.target_file != '' }}
        id: submit_job
        timeout-minutes: 20
        uses: foundriesio/lava-action@v6
        with:
          lava_token: ${{ secrets.LAVA_TOKEN }}
          lava_url: 'lava.infra.foundries.io'
          job_definition: ${{ steps.listjobs.outputs.target_file }}
          wait_for_job: true
          fail_action_on_failure: true
          save_result_as_artifact: true
          save_job_details: true

      - name: Download Artifacts
        if: ${{ steps.submit_job.outcome == 'success' }}
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: Extract test summary
        if: ${{ steps.submit_job.outcome == 'success' }}
        run: |
          file=$(ls test-results*/*)
          TESTS=$(grep -oP '<testsuites[^>]+tests="\K[0-9]+' $file)
          FAILURES=$(grep -oP '<testsuites[^>]+failures="\K[0-9]+' $file)
          TIME=$(grep -oP '<testsuites[^>]+time="\K[0-9.]+' $file)

          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tests:** $TESTS" >> $GITHUB_STEP_SUMMARY
          echo "**Failures:** $FAILURES" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $TIME seconds" >> $GITHUB_STEP_SUMMARY

      - name: Extract job summary
        if: ${{ steps.submit_job.outcome == 'success' }}
        run: |
          file=$(ls test-job*/*)
          JOB_ID=$(jq '.id' $file)
          STATE=$(jq '.state' $file)
          SUBMIT_TIME=$(jq '.submit_time' $file)
          JOB_URL=$(jq -r '.url' $file)

          echo "## Test Job Details" >> $GITHUB_STEP_SUMMARY
          echo "**Job ID:** $JOB_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Submit Time:** $SUBMIT_TIME" >> $GITHUB_STEP_SUMMARY
          echo "**Job URL:** [$JOB_URL]($JOB_URL)" >> $GITHUB_STEP_SUMMARY

      - name: Update Summary
        if: success() || failure()
        run: |
          if [ "${{ steps.submit_job.outcome }}" == "success" ]; then
            echo "## Test Job Summary" >> $GITHUB_STEP_SUMMARY
            echo ":heavy_check_mark: Test job for ${{ matrix.build_matrix.machine }} completed successfully." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Test Job Summary" >> $GITHUB_STEP_SUMMARY
            echo ":x: Test job for ${{ matrix.build_matrix.machine }} failed." >> $GITHUB_STEP_SUMMARY
          fi
