name: Build Docker Image
description: Build Docker Image Action

outputs:
  image_name:
    description: Name of the built Docker image
    value: ${{ steps.build.outputs.image_name }}

runs:
  using: "composite"
  steps:
    # Checkout ar-image repository to get the Dockerfile
    - name: Checkout ar-image repo for Dockerfile
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        repository: Audioreach/ar-image
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Pre-Build Docker Image
      shell: bash
      run: |
        echo "::group::$(printf '__________ %-100s' 'build' | tr ' ' _)"
    - name: Build Docker Image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ar-image:latest
        build-args: |
          "USER=$(whoami)"
          "UID=$(id -u)"
          "GID=$(id -g)"
        cache-from: type=gha
        cache-to: type=gha,mode=max
    - name: Post-Build Docker Image
      shell: bash
      run: |
        echo "::endgroup::"
        echo "Docker image ar-image:latest built successfully."
        echo "image_name=ar-image:latest" >> $GITHUB_OUTPUT

    # Checkout the main repo again for later steps
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.ref }}
